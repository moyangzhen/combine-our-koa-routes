!function(e){var t={};function o(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,o),r.l=!0,r.exports}o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)o.d(n,r,function(t){return e[t]}.bind(null,r));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=22)}([function(e,t,o){"use strict";t.a={DB_URL:"mongodb://test:123456@8.134.11.242:27017/testdb",REDIS:{host:"8.134.11.242",port:15001,password:"123456"},JWT_SECRET:"a&*38QthAKuiRwISGLotgq^3%^$zvA3A6Hfr8MF$jM*dWcwAW&9NGp7*b53!"}},function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("koa-router")},function(e,t){e.exports=require("redis")},function(e,t){e.exports=require("koa")},function(e,t){e.exports=require("koa-jwt")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("koa-body")},function(e,t){e.exports=require("koa-json")},function(e,t){e.exports=require("koa-compose")},function(e,t){e.exports=require("koa2-cors")},function(e,t){e.exports=require("koa-combine-routers")},function(e,t){e.exports=require("svg-captcha")},function(e,t){e.exports=require("bluebird")},function(e,t){e.exports=require("nodemailer")},function(e,t){e.exports=require("moment")},function(e,t){e.exports=require("jsonwebtoken")},function(e,t){e.exports=require("koa-helmet")},function(e,t){e.exports=require("koa-static")},function(e,t){e.exports=require("koa-compress")},function(e,t,o){"use strict";t.a=(e,t)=>t().catch(t=>{401===t.status?(e.status=401,e.body={code:401,msg:"Protect resource, use Authorization header to get access\n"}):(e.status=t.status||500,e.body={code:500,msg:(production,{stack:t.stack})})})},function(e,t,o){"use strict";var n=o(11),r=o.n(n),s=o(2),i=o.n(s),a=o(12),c=o.n(a),u=o(3),d=o.n(u),p=o(13),l=o(0);const f={host:l.a.REDIS.host,port:l.a.REDIS.port,password:l.a.REDIS.password,detect_buffers:!0,retry_strategy:function(e){return"ECONNREFUSED"===e.error.code?new Error("The server refused the connection"):e.total_retry_time>36e5?new Error("Retry time exhausted"):e.times_connected>10?void 0:Math.max(100*e.attempt,3e3)}},g=Object(p.promisifyAll)(d.a.createClient(f));g.on("error",e=>{console.log("Redis client error"+e)});var m=new class{constructor(){}async getCaptcha(e){const t=e.request.query,o=c.a.create({size:4,ignoreChars:"0o1i",color:!0,noise:Math.floor(5*Math.random()),height:38,width:150});var n,r,s;n=t.sid,r=o.text,s=600,void 0!==r&&null!=r&&""!==r&&("string"==typeof r?"undefine"!=typeof s?g.set(n,r,"EX",s):g.set(n,r):"object"==typeof r&&Object.keys(r).forEach(e=>{g.hset(n,e,r[e],d.a.print)})),e.body={code:200,data:o.data}}};const b=new i.a;b.prefix("/public"),b.get("/getCaptcha",m.getCaptcha);var y=b,x=o(14),h=o.n(x);var v=async function(e){let t=h.a.createTransport({host:"smtp.qq.com",port:587,secure:!1,auth:{user:"624973033@qq.com",pass:"ejjpuhxzlbqpbfjg"}});return"Message sent: %s, "+(await t.sendMail({from:'"认证邮件" <624973033@qq.com>',to:e.email,subject:""!==e.user?`你好开发者,${e.user}!<慕课网前端全栈实战>注册码`:"《慕课网前端全栈实战》注册码",text:`您在《慕课网前端全栈实战》课程中注册，您的邀请码是${e.code},邀请码的过期时间:${e.expire}`,html:`  <div style="color:#676767;width:600px;margin:0 auto;padding-bottom: 50px;position:relative;">\n    <div style="height: 60px;\nbackground: #393d49;\nline-height: 60px;\ncolor: #58a36f;\nfont-size: 18px;\npadding-left: 10px;">\n      Imooc社区-欢迎来到官方社区\n    </div>\n    <div style="padding:25px;">\n      <div>您好，${e.user}童靴，重置链接有效时间30分钟，请在${e.expire}之前重置您的密码:</div>\n      <a href="http://www.imooc.com" style=" padding: 10px 20px;color: #fff;background: #009e94;display:inline-block;margin:15px 0;">重置密码</a>\n  <div style="padding:5px;background:#f2f2f2;">如果该邮件不是由你本人操作，请勿进行激活！否则你的邮箱将会被他人绑定</div>\n    </div>\n    <div style="background: #fafafa;\ncolor: #b4b4b4;\ntext-align: center;\nline-height: 45px;\nheight: 45px;\nposition: absolute;\nleft: 0;\nbottom: 0;\nwidth: 100%;\n      ">系统邮件，请勿直接回复</div>`})).messageId},w=o(15),q=o.n(w),k=o(16),j=o.n(k);const _=async(e,t)=>{const o=await(e=>g.getAsync(e))(e);return null!==o&&o.toLowerCase()===t.toLowerCase()};var E=o(1),S=o.n(E);S.a.connect(l.a.DB_URL,{useNewUrlParser:!0,useUnifiedTopology:!0}),S.a.connection.on("connected",()=>{console.log("mongoose connection open to "+l.a.DB_URL)}),S.a.connection.on("error",e=>{console.log("mongoose connection error "+e)}),S.a.connection.on("disconnected",()=>{console.log("mongoose connection disconnected")});var R=S.a;const M=new(0,R.Schema)({username:{type:String},password:{type:String}});var O=R.model("users",M);var C=new class{constructor(){}async forget(e){const{body:t}=e.request;try{let o=await v({code:"1234",expire:q()().add(30,"minutes").format("YYYY-MM-DD HH:mm:ss"),email:t.username,user:"ludaohua"});e.body={code:200,data:o,msg:"邮件发送成功"}}catch(e){console.log(e)}}async login(e){const{body:t}=e.request;let o=t.sid,n=t.code;if(await _(o,n)){let o=!1;if((await O.findOne({username:t.username})).password===t.password&&(o=!0),o){let t=j.a.sign({_id:"brian"},l.a.JWT_SECRET,{expiresIn:"1d"});e.body={code:200,token:t}}else e.body={code:404,msg:"用户名或密码错误"}}else e.body={code:401,msg:"图片验证码不正确，请检查"}}async regist(e){}};const T=new i.a;T.prefix("/login"),T.post("/forget",C.forget),T.post("/login",C.login),T.post("/regist",C.regist);var D=T;t.a=r()(y,D)},function(e,t,o){"use strict";o.r(t),function(e){var t=o(4),n=o.n(t),r=o(5),s=o.n(r),i=o(6),a=o.n(i),c=o(7),u=o.n(c),d=o(8),p=o.n(d),l=o(9),f=o.n(l),g=o(10),m=o.n(g),b=o(21),y=o(17),x=o.n(y),h=o(18),v=o.n(h),w=o(19),q=o.n(w),k=o(0),j=o(20);const _=new n.a,E="production"!=production,S=s()({secret:k.a.JWT_SECRET}).unless({path:[/^\/public/,/\/login/]}),R=f()([u()(),v()(a.a.join(e,"../public")),m()(),p()({pretty:!1,param:"pretty"}),x()(),j.a,S]);E||_.use(q()()),_.use(R),_.use(Object(b.a)()),_.listen(3e3)}.call(this,"src")}]);